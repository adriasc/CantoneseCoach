<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
  <title>Cantonese Coach</title>
  <meta name="theme-color" content="#112d4e">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="CanCoach">
  <link rel="manifest" href="manifest.webmanifest">
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="bg-shape shape-a"></div>
  <div class="bg-shape shape-b"></div>

  <main class="app-shell">
    <header class="topbar">
      <div>
        <p class="eyebrow">Daily Cantonese <span class="version-tag">v19.4.16</span></p>
        <h1 id="appTitle">Cantonese Coach</h1>
      </div>
      <div class="topbar-right">
        <div class="streak" id="streakBadge">üî• 0th-Day</div>
        <button id="openSettings" class="gear-btn" type="button" aria-label="Open audio and display settings"><span class="gear-lines" aria-hidden="true"></span></button>
      </div>
    </header>

    <nav class="tabs">
      <button class="tab is-active" data-tab="words">Learn Words</button>
      <button class="tab" data-tab="patterns">Build Sentences</button>
      <button class="tab" data-tab="listening">Listen &amp; Choose</button>
      <button class="tab" data-tab="questions">Ask &amp; Answer</button>
      <button class="tab" data-tab="tones">Tone Drill</button>
      <button class="tab" data-tab="exercises">Exercises</button>
      <button class="tab" data-tab="settings">Content</button>
      <button class="tab fun-tab" id="openFunLoop" type="button">Fun Loop</button>
    </nav>

    <section class="card controls-card">
      <div class="card-head">
        <h2>Practice Controls</h2>
        <button id="toggleControlsCard" class="ghost-btn" type="button" aria-label="Collapse or expand practice controls">‚åÑ</button>
      </div>
      <div class="slot-grid controls-grid">
        <div id="globalLevelWrap" class="general-control">
          <label for="globalLevel">Level</label>
          <select id="globalLevel">
            <option value="1">Level 1 - short</option>
            <option value="2">Level 2 - medium</option>
            <option value="3">Level 3 - advanced</option>
            <option value="4">Level 4 - long/conditional</option>
            <option value="mixed">Mixed levels</option>
          </select>
        </div>
        <div id="globalTenseWrap" class="general-control">
          <label for="globalTense">Verb Time</label>
          <select id="globalTense">
            <option value="mixed">Mixed</option>
            <option value="present">Present</option>
            <option value="past">Past</option>
            <option value="future">Future</option>
            <option value="conditional">Conditional</option>
          </select>
        </div>
        <div id="wordFilterWrap" class="general-control hidden">
          <label for="wordFilter">Word Filter</label>
          <select id="wordFilter">
            <option value="mixed">Mixed (all words)</option>
            <option value="past_markers">Past markers only</option>
            <option value="future_markers">Future markers only</option>
            <option value="present_markers">Present markers only</option>
            <option value="conditional_markers">Conditional markers only</option>
            <option value="verbs">Verbs</option>
            <option value="nouns">Nouns</option>
            <option value="time">Time words</option>
            <option value="grammar">Grammar words</option>
            <option value="adjectives">Adjectives</option>
            <option value="adverbs">Adverbs</option>
            <option value="pronouns">Pronouns</option>
            <option value="places">Places</option>
            <option value="conjunctions">Conjunctions</option>
            <option value="prepositions">Prepositions</option>
            <option value="measure_words">Measure words</option>
            <option value="particles">Particles</option>
            <option value="aspect_markers">Aspect markers</option>
          </select>
        </div>
        <div id="globalThemeWrap" class="general-control">
          <label for="globalTheme">Theme</label>
          <select id="globalTheme">
            <option value="mixed">Mixed</option>
            <option value="home">Home/Family</option>
            <option value="friends">Friends</option>
            <option value="travel">Travel/Going out</option>
            <option value="daily">Daily routines</option>
            <option value="holiday">Holiday plans</option>
          </select>
        </div>
        <div id="questionLevelWrap" class="question-control hidden">
          <label for="questionLevel">Question Level</label>
          <select id="questionLevel">
            <option value="basic">Basic Questions</option>
            <option value="advanced">Advanced Questions</option>
          </select>
        </div>
        <div id="questionTenseWrap" class="question-control hidden">
          <label for="questionTense">Verb Time</label>
          <select id="questionTense">
            <option value="mixed">Mixed</option>
            <option value="present">Present</option>
            <option value="past">Past</option>
            <option value="future">Future</option>
            <option value="conditional">Conditional</option>
          </select>
        </div>
        <div id="questionThemeWrap" class="question-control hidden">
          <label for="questionTheme">Theme</label>
          <select id="questionTheme">
            <option value="mixed">Mixed</option>
            <option value="home">Home/Family</option>
            <option value="friends">Friends</option>
            <option value="travel">Travel/Going out</option>
            <option value="daily">Daily routines</option>
            <option value="holiday">Holiday plans</option>
          </select>
        </div>
        <div id="toneModeWrap" class="general-control hidden">
          <label for="toneExerciseMode">Tone Exercise</label>
          <select id="toneExerciseMode">
            <option value="word">Word pairs</option>
            <option value="sentence">Sentence pairs (L3+)</option>
          </select>
        </div>
      </div>
      <div class="actions">
        <button id="applyControls">Apply Settings</button>
      </div>
      <p class="example" id="controlsMessage"></p>
    </section>

    <div class="modal hidden" id="settingsModal">
      <div class="modal-card">
        <div class="card-head">
          <h2>Audio & Display</h2>
          <button id="closeSettings" class="ghost-btn" type="button">‚úï</button>
        </div>
        <div class="slot-grid">
          <div>
            <label for="audioVoice">Audio Voice</label>
            <select id="audioVoice">
              <option value="auto">Auto (best Cantonese)</option>
            </select>
          </div>
          <div>
            <label for="audioRate">Audio Speed (<span id="audioRateValue">0.90x</span>)</label>
            <input id="audioRate" type="range" min="0.6" max="1.2" step="0.05" value="0.9">
          </div>
          <div>
            <label for="themeStyle">Theme Style</label>
            <select id="themeStyle">
              <option value="classic">Classic Pastel</option>
              <option value="harbour">HK Harbour Pastel</option>
              <option value="neon">HK Neon Soft</option>
              <option value="neon-strong">HK Neon Strong</option>
              <option value="neon-extreme">HK Neon Extreme</option>
              <option value="ink">Ink Newspaper</option>
              <option value="poster">HK Poster Pop</option>
            </select>
          </div>
          <div>
            <label for="languageMode">Language Mode</label>
            <select id="languageMode">
              <option value="cantonese">Cantonese (Hanzi + Jyutping)</option>
              <option value="mandarin">Mandarin (Simplified + Pinyin)</option>
              <option value="compare">Compare (Cantonese + Mandarin)</option>
            </select>
          </div>
          <div>
            <label for="audioNoiseOn">Voice Noise</label>
            <select id="audioNoiseOn">
              <option value="off">Off</option>
              <option value="on">On</option>
            </select>
          </div>
          <div>
            <label for="audioNoiseType">Noise Type</label>
            <select id="audioNoiseType">
              <option value="white">White noise</option>
              <option value="street">Street</option>
              <option value="radio">Radio</option>
              <option value="people">People talking</option>
              <option value="real-market">Real wet market (beta)</option>
              <option value="real-radio">Real radio chatter (beta)</option>
            </select>
          </div>
          <div>
            <label for="audioNoiseLevel">Noise Level (<span id="audioNoiseValue">0.25</span>)</label>
            <input id="audioNoiseLevel" type="range" min="0.05" max="0.80" step="0.01" value="0.25">
          </div>
        </div>
        <div class="actions">
          <button id="testVoice" class="play-icon-btn" aria-label="Test voice playback">‚ñ∂</button>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="funModal">
      <div class="modal-card">
        <div class="card-head">
          <h2>Fun Loop</h2>
          <button id="closeFunLoop" class="ghost-btn" type="button">‚úï</button>
        </div>
        <p class="example">Daily mission (resets every day). XP = points. Combo = correct answers in a row. Mistakes = saved wrong items.</p>
        <div class="mini-stats">
          <p id="xpLine">XP: 0 ¬∑ Level 1</p>
          <p id="comboLine">Combo: x0</p>
          <p id="mistakeCount">Mistakes: 0</p>
        </div>
        <div class="mission-grid">
          <p id="missionListens">Listen: 0 / 10</p>
          <p id="missionTones">Tone wins: 0 / 5</p>
          <p id="missionPatterns">Sentence drills: 0 / 3</p>
          <p id="missionHanzi">Hanzi tests: 0 / 3</p>
        </div>
        <p class="goal-line" id="missionGoal">Goal today: complete all 4 targets, then pass Boss (4/5).</p>
        <div class="actions">
          <button id="toggleFixMode">Fix Mistakes: Off</button>
          <button id="startBoss">Start Boss Challenge</button>
        </div>
        <p class="feedback" id="funFeedback"></p>
        <div class="boss-wrap hidden" id="bossWrap">
          <p class="formula" id="bossProgress">Boss 1/5</p>
          <p id="bossPrompt"></p>
          <div class="choices" id="bossChoices"></div>
          <div class="actions">
            <button id="bossPlayAudio" class="play-icon-btn" aria-label="Play challenge audio">‚ñ∂</button>
            <button id="bossSkip">Skip</button>
          </div>
        </div>
      </div>
    </div>

    <div class="modal hidden" id="grammarModal">
      <div class="modal-card grammar-modal-card">
        <div class="card-head">
          <h2 id="grammarModalTitle">Grammar Info</h2>
          <button id="closeGrammarModal" class="ghost-btn" type="button">‚úï</button>
        </div>
        <div id="grammarModalBody" class="grammar-modal-body"></div>
      </div>
    </div>

    <section class="panel is-active" id="panel-words">
      <div class="card" id="wordCard">
        <p class="chip" id="wordCategory">Category</p>
        <h2 class="hanzi" id="wordHanzi">Êàë</h2>
        <p class="jyutping" id="wordJyutping">ngo5</p>
        <p class="english" id="wordEnglish">I / me</p>
        <p class="literal hidden" id="wordLiteral"></p>
        <div class="actions pattern-actions panel-actions">
          <div class="pattern-control-col">
            <button id="nextWord" class="pattern-next-btn" aria-label="Next word">‚Üó</button>
            <p class="pattern-control-text">Next</p>
          </div>
          <div class="pattern-control-col">
            <button id="markKnown" class="pattern-mini-btn" aria-label="Mark word as known">‚úì</button>
            <p class="pattern-control-text">Known</p>
          </div>
          <div class="pattern-control-col">
            <button id="playWordAudio" class="play-icon-btn pattern-play-main" aria-label="Play word audio">‚ñ∂</button>
            <p class="pattern-control-text">Play</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleWordJyutping" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Jyutping">Á≤µ</button>
            <p class="pattern-control-text" id="wordJpText">Jyutping</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleWordEnglish" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle English">EN</button>
            <p class="pattern-control-text">English</p>
          </div>
        </div>
        <div class="actions word-example-actions">
          <button id="revealExample">Show example</button>
        </div>
        <p class="example" id="wordExample"></p>
      </div>
      <div class="mini-stats">
        <p id="knownWords">Known words: 0</p>
        <p id="reviewedWords">Reviewed today: 0</p>
      </div>
      <div class="actions">
        <button id="toggleKnownList">Show known list</button>
      </div>
      <div class="card hidden" id="knownListWrap">
        <h3>Known Words</h3>
        <p class="example" id="knownListMeta">No words marked yet.</p>
        <div class="actions known-list-actions">
          <button id="clearKnownList" type="button">Clear all known</button>
        </div>
        <div class="known-list" id="knownList"></div>
      </div>
    </section>

    <section class="panel" id="panel-patterns">
      <div class="card">
        <h2>Build Sentences</h2>
        <p class="formula" id="patternFormula"></p>
        <div class="slot-grid" id="slotGrid"></div>
        <div class="result-box">
          <p class="hanzi" id="patternHanzi"></p>
          <p class="jyutping" id="patternJyutping"></p>
          <p class="english" id="patternEnglish"></p>
          <p class="literal" id="patternLiteral"></p>
          <div class="grammar-notes" id="patternGrammarNotes"></div>
        </div>
        <div class="actions pattern-actions">
          <div class="pattern-control-col">
            <button id="newPattern" class="pattern-next-btn" aria-label="Next pattern">‚Üó</button>
            <p class="pattern-control-text" id="patternNextText">Next</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleGrammarLens" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle grammar lens">‚óé</button>
            <p class="pattern-control-text" id="patternLensText">Lens</p>
          </div>
          <div class="pattern-control-col">
            <button id="playPatternAudio" class="play-icon-btn pattern-play-main" aria-label="Play pattern sentence">‚ñ∂</button>
            <p class="pattern-control-text">Play</p>
          </div>
          <div class="pattern-control-col">
            <button id="togglePatternJyutping" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Jyutping">Á≤µ</button>
            <p class="pattern-control-text" id="patternJpText">Jyutping</p>
          </div>
          <div class="pattern-control-col">
            <button id="togglePatternEnglish" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle English">EN</button>
            <p class="pattern-control-text" id="patternEnText">English</p>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="panel-listening">
      <div class="card">
        <h2>Listen &amp; Choose</h2>
        <p>Tap play, listen, then choose the correct English meaning.</p>
        <p class="hanzi hidden" id="quizHanzi"></p>
        <p class="jyutping hidden" id="quizJyutping"></p>
        <p class="english hidden" id="quizEnglish"></p>
        <p class="literal" id="quizLiteral"></p>
        <div class="grammar-notes" id="quizGrammarNotes"></div>
        <div class="actions pattern-actions panel-actions">
          <div class="pattern-control-col">
            <button id="nextQuiz" class="pattern-next-btn" aria-label="Next quiz">‚Üó</button>
            <p class="pattern-control-text">Next</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleQuizGrammarLens" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle grammar lens">‚óé</button>
            <p class="pattern-control-text">Lens</p>
          </div>
          <div class="pattern-control-col">
            <button id="playQuizAudio" class="play-icon-btn pattern-play-main" aria-label="Play listening clip">‚ñ∂</button>
            <p class="pattern-control-text">Play</p>
          </div>
          <div class="pattern-control-col">
            <button id="showQuizText" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Chinese">‰∏≠</button>
            <p class="pattern-control-text">Chinese</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleQuizJyutping" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Jyutping">Á≤µ</button>
            <p class="pattern-control-text">Jyutping</p>
          </div>
          <div class="pattern-control-col hidden" id="quizEnglishControl">
            <button id="toggleQuizEnglish" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle English">EN</button>
            <p class="pattern-control-text">English</p>
          </div>
        </div>
        <div class="choices" id="quizChoices"></div>
        <p class="feedback" id="quizFeedback"></p>
      </div>
    </section>

    <section class="panel" id="panel-questions">
      <div class="card">
        <h2>Ask &amp; Answer</h2>
        <p>Question-only training with natural English + literal structure. Use Practice Controls above for filters.</p>
        <p class="formula" id="questionFormula"></p>
        <div class="result-box">
          <p class="hanzi" id="questionHanzi"></p>
          <p class="jyutping" id="questionJyutping"></p>
          <p class="english" id="questionEnglish"></p>
          <p class="literal" id="questionLiteral"></p>
        </div>
        <div class="actions pattern-actions panel-actions">
          <div class="pattern-control-col">
            <button id="nextQuestion" class="pattern-next-btn" aria-label="Next question">‚Üó</button>
            <p class="pattern-control-text">Next</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleQuestionGrammarLens" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle grammar lens">‚óé</button>
            <p class="pattern-control-text">Lens</p>
          </div>
          <div class="pattern-control-col">
            <button id="playQuestionAudio" class="play-icon-btn pattern-play-main" aria-label="Play question audio">‚ñ∂</button>
            <p class="pattern-control-text">Play</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleQuestionJyutping" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Jyutping">Á≤µ</button>
            <p class="pattern-control-text" id="questionJpText">Jyutping</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleQuestionEnglish" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle English">EN</button>
            <p class="pattern-control-text">English</p>
          </div>
        </div>
      </div>
    </section>

    <section class="panel" id="panel-tones">
      <div class="card">
        <h2>Tone Drill</h2>
        <p>Press A, B, or Random. Then choose the Jyutping or sentence you just heard.</p>
        <p class="formula" id="toneLabel"></p>
        <p class="example" id="tonePrompt">Step 1: Play a clip. Step 2: Choose meaning below.</p>
        <div class="result-box">
          <p class="hanzi tone-line" id="toneHanzi"></p>
          <p class="jyutping tone-line" id="toneJyutping"></p>
          <p class="english tone-line" id="toneEnglish"></p>
        </div>
        <div class="actions pattern-actions panel-actions tone-actions">
          <div class="pattern-control-col">
            <button id="playToneA" class="play-icon-btn tone-play-btn" aria-label="Play tone A" data-tone-label="A">‚ñ∂</button>
            <p class="pattern-control-text">Play A</p>
          </div>
          <div class="pattern-control-col">
            <button id="playToneB" class="play-icon-btn tone-play-btn" aria-label="Play tone B" data-tone-label="B">‚ñ∂</button>
            <p class="pattern-control-text">Play B</p>
          </div>
          <div class="pattern-control-col">
            <button id="playToneRandom" class="play-icon-btn tone-play-btn" aria-label="Play random tone" data-tone-label="?">‚ñ∂</button>
            <p class="pattern-control-text">Random</p>
          </div>
          <div class="pattern-control-col hidden" id="toneJyutpingControl">
            <button id="toggleToneJyutping" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle Jyutping" disabled>Á≤µ</button>
            <p class="pattern-control-text">Jyutping</p>
          </div>
          <div class="pattern-control-col">
            <button id="toggleToneEnglish" class="pattern-mini-btn pattern-toggle-btn is-off" aria-pressed="false" aria-label="Toggle English">EN</button>
            <p class="pattern-control-text">English</p>
          </div>
          <div class="pattern-control-col">
            <button id="nextTone" class="pattern-next-btn" aria-label="Next tone pair">‚Üó</button>
            <p class="pattern-control-text">Next</p>
          </div>
        </div>
        <div class="choices" id="toneChoices"></div>
        <p class="feedback" id="toneFeedback"></p>
        <p class="example" id="toneScore">Tone score: 0 / 0</p>
      </div>
    </section>

    <section class="panel" id="panel-exercises">
      <div class="card">
        <h2>Exercises</h2>
        <p>Read the English line, then tap the Hanzi blocks to build the correct sentence.</p>
        <p class="formula" id="exercisePrompt"></p>
        <div class="result-box">
          <p class="hanzi" id="exerciseBuilt"></p>
          <div class="exercise-selected" id="exerciseSelected"></div>
        </div>
        <div class="exercise-bank" id="exerciseTokenBank"></div>
        <div class="actions pattern-actions panel-actions exercise-actions">
          <div class="pattern-control-col">
            <button id="clearExercise" class="pattern-mini-btn pattern-toggle-btn is-off" aria-label="Clear current exercise">‚Ü∫</button>
            <p class="pattern-control-text">Clear</p>
          </div>
          <div class="pattern-control-col">
            <button id="checkExercise" class="pattern-mini-btn pattern-toggle-btn is-on" aria-label="Check answer">‚úì</button>
            <p class="pattern-control-text">Check</p>
          </div>
          <div class="pattern-control-col">
            <button id="playExerciseAudio" class="play-icon-btn pattern-play-main" aria-label="Play exercise sentence">‚ñ∂</button>
            <p class="pattern-control-text">Play</p>
          </div>
          <div class="pattern-control-col">
            <button id="nextExercise" class="pattern-next-btn" aria-label="Next exercise">‚Üó</button>
            <p class="pattern-control-text">Next</p>
          </div>
        </div>
        <p class="feedback" id="exerciseFeedback"></p>
      </div>
    </section>

    <section class="panel" id="panel-stories">
      <div class="card">
        <h2>Stories</h2>
        <p>This section is ready for short Cantonese stories with audio, Jyutping, and English.</p>
        <p class="example">Next step: add story packs (home, travel, friends) and read-along mode.</p>
      </div>
    </section>

    <section class="panel" id="panel-settings">
      <div class="card">
        <h2>Content Manager</h2>
        <p>Your app uses built-in basic words now. Import your own JSON to match your exact PDF list.</p>
        <div class="actions">
          <label class="file-btn" for="importFile">Import JSON</label>
          <input id="importFile" type="file" accept="application/json">
          <button id="exportData">Export current JSON</button>
          <button id="resetData">Reset built-in words</button>
        </div>
        <details>
          <summary>Expected JSON format</summary>
          <pre>{
  "words": [
    {
      "id": "w1",
      "hanzi": "Êàë",
      "jyutping": "ngo5",
      "mandarin_hanzi": "Êàë",
      "pinyin": "w«í",
      "english": "I / me",
      "mandarin_english": "I / me",
      "intent_id": "pronoun_i",
      "category": "pronoun",
      "example": "ÊàëÂ≠∏Âª£Êù±Ë©±„ÄÇ"
    }
  ],
  "patterns": [...],
  "quiz": [...]
}</pre>
        </details>
        <p id="contentMessage"></p>
      </div>
    </section>
  </main>

  <nav id="bottomNav" class="bottom-nav hidden" aria-label="Basic navigation">
    <button class="bottom-nav-btn is-active" type="button" data-bottom-tab="words">Home</button>
    <button class="bottom-nav-btn" type="button" data-bottom-tab="tones">Tones</button>
    <button class="bottom-nav-btn" type="button" data-bottom-tab="stories">Stories</button>
    <button class="bottom-nav-btn" type="button" data-bottom-tab="patterns">Learn</button>
  </nav>

  <div id="fxLayer" class="fx-layer" aria-hidden="true"></div>
  <script src="app.js"></script>
</body>
</html>
